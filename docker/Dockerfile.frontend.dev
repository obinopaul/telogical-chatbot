FROM node:18-alpine

WORKDIR /app

# Create .env.local with required environment variables
# Note: The actual values will be provided through environment variables in the compose file
RUN touch .env.local && \
    echo "USE_TELOGICAL_BACKEND=true" >> .env.local && \
    echo "TELOGICAL_API_URL=http://backend:8081" >> .env.local && \
    echo "AUTH_SECRET=random_secret_string_here" >> .env.local && \
    echo "SKIP_DB_MIGRATION=true" >> .env.local && \
    echo "SKIP_AUTH_SETUP=true" >> .env.local

# Expose port
EXPOSE 3000

# Simple startup script that just installs uuid specifically for auth.ts
CMD sh -c "echo 'POSTGRES_URL=${POSTGRES_URL}' >> .env.local && \
    mkdir -p /app/app/\\(auth\\)/ && \
    cp /app/docker/mock-auth.ts /app/app/\\(auth\\)/auth.ts && \
    npm install && \
    (npx tsx lib/db/migrate.ts || echo 'Migration skipped - tables may need manual creation') && \
    npm run dev"